<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Luxta Academy - Web2</title>
<style>
  @font-face {
    font-family: 'Pixil';
    src: url('Pixil.otf') format('opentype');
  }
  
  body {
    background:#111; color:white;
    display:flex; align-items:center; justify-content:center;
    height:100vh; font-size:20px;
    font-family: 'Pixil', monospace;
  }
</style>
</head>
<body>
  <p id="status">Đang kiểm tra...</p>

</body>
<script>
  // --- lấy token từ URL hoặc localStorage ---
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get("token") || localStorage.getItem("luxta_token");

  const statusEl = document.getElementById("status");

  if (!token) {
    statusEl.innerText = "Token không hợp lệ.";
  } else {
    statusEl.innerText = "Đang kiểm tra token...";

    const delay = Math.random() * (3000 - 1500) + 1500;

    setTimeout(async () => {
      try {
        // --- gửi request redeem token ---
        const redeemRes = await fetch(
          "https://render-backend-wnt8.onrender.com/use-token",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token })
          }
        );

        const redeemData = await redeemRes.json();

        // ❌ server trả về lỗi hợp lệ → xoá token
        if (!redeemData.ok) {
          statusEl.innerText = redeemData.error || "Token không hợp lệ";
          localStorage.removeItem("luxta_token");
          return;
        }

        // ✅ thành công → xoá token
        localStorage.removeItem("luxta_token");

        statusEl.innerText =
          `Đã cộng ${redeemData.added} coin!`;

        setTimeout(() => {
          if (window.ReactNativeWebView) {
            window.ReactNativeWebView.postMessage("close");
          }
          window.close();
        }, 1200);

      } catch (err) {
        // ⚠️ lỗi mạng / server chết → KHÔNG xoá token
        console.error(err);
        statusEl.innerText = "Không kết nối được server, vui lòng thử lại";
      }
    }, delay);
  }
</script>
</html>
