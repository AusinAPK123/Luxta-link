<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Testrix nhái</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family: 'Segoe UI', sans-serif; }
  
    html, body {
      display: flex;
      height: 100%;
      width: 100%;
      justify-content: top;
      align-items: center;
      flex-direction: column;
      background: #5a5a5a;
    }
    
    #top {
      display: flex;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100px;
      background: #c879ff;
      justify-content: space-between;
      padding: 20px;
      align-items: center;
      box-sizing: border-box;
    }
    
    #score { color: #ffffff; }
    #n_block {
      background: #5a5a5a;
      border: 4px solid #303030;
      height: 70px;
      width: 70px;
      border-radius: 5px;
    }
    
    #screen {
      position: absolute;
      top: 120px;
      width: 224px;
      height: 448px;
      background: #3c3c3c;
      box-shadow: 0 0 10px #ffffff;
      display: grid;
      grid-template-columns: repeat(10, 22.4px);
      grid-template-rows: repeat(20, 22.4px);
      border-radius: 5px;
        }
    
    .cell {
      width: 22.4px;
      height: 22.4px;
      background: #c879ff;
      border-top: 4px solid #8a3fcc;
      border-left: 4px solid #8a3fcc;
      border-bottom: 4px solid #e0b0ff;
      border-right: 4px solid #e0b0ff;
      aspect-ratio: 1 / 1;
    }

    /*===========  THANH ĐIỀU KHIỂN ===========*/
    #controls {
      position: fixed;
      bottom: 0;
      width: 100%;
      height: 120px;
      background: transparent;
      display: flex;
      justify-content: space-between;
      padding: 15px;
      box-sizing: border-box;
    }

    /* LEFT: ← ↓ → */
    #move_btns {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    /* RIGHT: xoay */
    #rotate_btns {
      display: flex;
      align-items: center;
    }

    .btn {
      width: 70px;
      height: 70px;
      background: #c879ff;
      color: #ffffff;
      padding: 15px;
      box-sizing: border-box;
      border-radius: 12px;
      display: flex;
      justify-content: center;
      align-items: center;
      user-select: none;
      border: 2px solid #b447ff;
    }

    .btn:active {
      background: #ddabff;
    }
    
    #n_block {
      background: #5a5a5a;
      border: 4px solid #303030;
      height: 70px;
      width: 70px;
      border-radius: 5px;
    
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden; /* quan trọng */
    }
  </style>
</head>
<body>
  <div id="top">
    <div id="score"><p id="score_t">Điểm: 0</p></div>
    <div id="n_block"></div>
  </div>
  
  <div id="screen"></div>

  <!-- ========== THANH NÚT TETRIS ========== -->
  <div id="controls">
    <!-- 3 nút trái / phải / xuống -->
    <div id="move_btns">
      <button class="btn" id="btn_left"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path fill="currentColor" d="M73.4 297.4C60.9 309.9 60.9 330.2 73.4 342.7L233.4 502.7C245.9 515.2 266.2 515.2 278.7 502.7C291.2 490.2 291.2 469.9 278.7 457.4L173.3 352L544 352C561.7 352 576 337.7 576 320C576 302.3 561.7 288 544 288L173.3 288L278.7 182.6C291.2 170.1 291.2 149.8 278.7 137.3C266.2 124.8 245.9 124.8 233.4 137.3L73.4 297.3z"/></svg></button>
      
      <button class="btn" id="btn_down"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path fill="currentColor" d="M297.4 566.6C309.9 579.1 330.2 579.1 342.7 566.6L502.7 406.6C515.2 394.1 515.2 373.8 502.7 361.3C490.2 348.8 469.9 348.8 457.4 361.3L352 466.7L352 96C352 78.3 337.7 64 320 64C302.3 64 288 78.3 288 96L288 466.7L182.6 361.3C170.1 348.8 149.8 348.8 137.3 361.3C124.8 373.8 124.8 394.1 137.3 406.6L297.3 566.6z"/></svg></button>
      
      <button class="btn" id="btn_right"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path fill="currentColor" d="M566.6 342.6C579.1 330.1 579.1 309.8 566.6 297.3L406.6 137.3C394.1 124.8 373.8 124.8 361.3 137.3C348.8 149.8 348.8 170.1 361.3 182.6L466.7 288L96 288C78.3 288 64 302.3 64 320C64 337.7 78.3 352 96 352L466.7 352L361.3 457.4C348.8 469.9 348.8 490.2 361.3 502.7C373.8 515.2 394.1 515.2 406.6 502.7L566.6 342.7z"/></svg></button>
    </div>

    <!-- nút xoay -->
    <div id="rotate_btns">
      <button class="btn" id="btn_rotate"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path fill="currentColor" d="M500.7 138.7L512 149.4L512 96C512 78.3 526.3 64 544 64C561.7 64 576 78.3 576 96L576 224C576 241.7 561.7 256 544 256L416 256C398.3 256 384 241.7 384 224C384 206.3 398.3 192 416 192L463.9 192L456.3 184.8C456.1 184.6 455.9 184.4 455.7 184.2C380.7 109.2 259.2 109.2 184.2 184.2C109.2 259.2 109.2 380.7 184.2 455.7C259.2 530.7 380.7 530.7 455.7 455.7C463.9 447.5 471.2 438.8 477.6 429.6C487.7 415.1 507.7 411.6 522.2 421.7C536.7 431.8 540.2 451.8 530.1 466.3C521.6 478.5 511.9 490.1 501 501C401 601 238.9 601 139 501C39.1 401 39 239 139 139C238.9 39.1 400.7 39 500.7 138.7z"/></svg></button>
    </div>
  </div>

</body>
<script>
const COLS = 10;
const ROWS = 20;
const board = document.getElementById("screen");
const scoreText = document.getElementById("score_t");

let isGameOver = false;
let score = 0, chain = 0;
let fallSpeed = 800; 
const minSpeed = 350;
const speedStep = 15;

const cells = [];
for (let i = 0; i < ROWS * COLS; i++) {
    const cell = document.createElement("div");
    cell.className = "cell";
    board.appendChild(cell);
    cells.push(cell);
}

const shapes = [
    [[1,1],[1,1]], [[1,1,1,1]], [[0,1,0],[1,1,1]], [[1,0,0],[1,1,1]],
    [[0,0,1],[1,1,1]], [[1,1,0],[0,1,1]], [[0,1,1],[1,1,0]], [[1,1,1],[0,1,0],[0,1,0]]
];

const COLORS = ["#73bf47","#7bbce8","#88bce3","#fcb1b1","#c4f0f2","#e5b0f5","#f5e7b0","#e3fcc5","#89b1e8","#f20f0f","#0f75f2","#e8a5a5","#fff700","#2c58df","#63ffd6","#bef600"];

function lightenColor(color, percent) {
    const num = parseInt(color.slice(1),16), amt = Math.round(2.55*percent), R = (num>>16)+amt, G = (num>>8 & 0x00FF)+amt, B = (num & 0x0000FF)+amt;
    return "#" + (0x1000000 + (R<255?R<1?0:R:255)*0x10000 + (G<255?G<1?0:G:255)*0x100 + (B<255?B<1?0:B:255)).toString(16).slice(1);
}
function darkenColor(color, percent) { return lightenColor(color, -percent); }
function pickColor() {
    const bg = COLORS[Math.floor(Math.random()*COLORS.length)];
    return { bg, highlight: lightenColor(bg,20), shadow: darkenColor(bg,20) };
}

const boardState = Array.from({length: ROWS}, ()=>Array(COLS).fill(0));

let nextShape = shapes[Math.floor(Math.random()*shapes.length)];
let nextColor = pickColor();
let shape, posX, posY, currentColor;

function drawShape(){
    if(!shape) return;
    cells.forEach((c,i)=>{
        const r = Math.floor(i/COLS), cIdx = i%COLS, d = boardState[r][cIdx];
        if(d && d.filled){
            c.style.background = d.color.bg;
            c.style.borderTop = `4px solid ${d.color.highlight}`;
            c.style.borderLeft = `4px solid ${d.color.highlight}`;
            c.style.borderBottom = `4px solid ${d.color.shadow}`;
            c.style.borderRight = `4px solid ${d.color.shadow}`;
        } else {
            c.style.background = '#808080';
            c.style.borderTop = '2px solid #3c3c3c';
            c.style.borderLeft = '2px solid #3c3c3c';
            c.style.borderBottom = '2px solid #3c3c3c';
            c.style.borderRight = '3px solid #3c3c3c';
        }
    });
    shape.forEach((row, y) => row.forEach((val, x) => {
        if(val){
            const dx = posX + x, dy = posY + y;
            if(dy>=0 && dy<ROWS && dx>=0 && dx<COLS){
                const idx = dy*COLS + dx;
                cells[idx].style.background = currentColor.bg;
                cells[idx].style.borderTop = `4px solid ${currentColor.highlight}`;
                cells[idx].style.borderLeft = `4px solid ${currentColor.highlight}`;
                cells[idx].style.borderBottom = `4px solid ${currentColor.shadow}`;
                cells[idx].style.borderRight = `4px solid ${currentColor.shadow}`;
            }
        }
    }));
}

function canMove(nx,ny,ns){
    return ns.every((row, y) => row.every((val, x) => {
        if(!val) return true;
        const cx = nx + x, cy = ny + y;
        if(cx<0 || cx>=COLS || cy>=ROWS) return false;
        if(cy>=0 && boardState[cy][cx] && boardState[cy][cx].filled) return false;
        return true;
    }));
}

function lockBlock(){
    shape.forEach((row, y) => row.forEach((val, x) => {
        if(val && (posY+y)>=0) boardState[posY+y][posX+x] = {filled:1, color:currentColor};
    }));
    let cleared = 0;
    for(let y=ROWS-1; y>=0; y--){
        if(boardState[y].every(c => c && c.filled)){
            boardState.splice(y,1);
            boardState.unshift(Array(COLS).fill(0));
            cleared++; y++;
        }
    }
    if(cleared > 0){
        chain++;
        score += (cleared===1?100:cleared===2?300:cleared===3?500:1000)*chain;
        scoreText.innerText = "Điểm: "+score;
        fallSpeed = Math.max(minSpeed, fallSpeed-speedStep);
    } else chain = 0;
}

function spawnBlock(){
    if(isGameOver) return;
    shape = nextShape; currentColor = nextColor;
    posX = Math.floor((COLS - shape[0].length)/2);
    posY = -shape.length;
    if (!canMove(posX, 0, shape)) {
        isGameOver = true;
        clearInterval(fallInterval);
        alert("GAME OVER!\nĐiểm: " + score);
        location.reload();
        return;
    }
    nextShape = shapes[Math.floor(Math.random()*shapes.length)];
    nextColor = pickColor();
    drawPreview();
}

function drawPreview(){
    const box = document.getElementById("n_block");
    box.innerHTML = "";
    box.style.display = "flex";
    box.style.justifyContent = "center";
    box.style.alignItems = "center";
    const rows = nextShape.length, cols = nextShape[0].length;
    const cellSize = 30, scale = 0.5;
    const previewContainer = document.createElement("div");
    previewContainer.style.position = "relative";
    previewContainer.style.width = (cols * cellSize) + "px";
    previewContainer.style.height = (rows * cellSize) + "px";
    previewContainer.style.transform = `scale(${scale})`;
    previewContainer.style.transformOrigin = "center"; 
    nextShape.forEach((row, y) => row.forEach((val, x) => {
        if(val){
            const cell = document.createElement("div");
            cell.style.position = "absolute";
            cell.style.width = cell.style.height = cellSize + "px";
            cell.style.left = (x * cellSize) + "px";
            cell.style.top  = (y * cellSize) + "px";
            cell.style.background = nextColor.bg;
            cell.style.borderTop = `4px solid ${nextColor.highlight}`;
            cell.style.borderLeft = `4px solid ${nextColor.highlight}`;
            cell.style.borderBottom = `4px solid ${nextColor.shadow}`;
            cell.style.borderRight = `4px solid ${nextColor.shadow}`;
            previewContainer.appendChild(cell);
        }
    }));
    box.appendChild(previewContainer);
}

// --- HỆ THỐNG ĐIỀU KHIỂN ĐA NHIỆM ---
const controls = {
    left: { t: null, i: null },
    right: { t: null, i: null },
    down: { t: null, i: null }
};

function moveLeft(){ if(!isGameOver && canMove(posX-1,posY,shape)) { posX--; drawShape(); } }
function moveRight(){ if(!isGameOver && canMove(posX+1,posY,shape)) { posX++; drawShape(); } }
function rotate(){
    if(isGameOver) return;
    const ns = shape[0].map((_, i) => shape.map(row => row[i]).reverse());
    if(canMove(posX,posY,ns)) { shape=ns; drawShape(); }
}

function setupControls() {
    const bindMove = (id, key, action) => {
        const btn = document.getElementById(id);
        const start = e => {
            e.preventDefault();
            if (isGameOver || controls[key].t || controls[key].i) return;
            action();
            controls[key].t = setTimeout(() => {
                controls[key].i = setInterval(action, 100);
            }, 200);
        };
        const end = () => {
            clearTimeout(controls[key].t); clearInterval(controls[key].i);
            controls[key].t = null; controls[key].i = null;
        };
        btn.onmousedown = btn.ontouchstart = start;
        btn.onmouseup = btn.onmouseleave = btn.ontouchend = end;
    };

    bindMove("btn_left", "left", moveLeft);
    bindMove("btn_right", "right", moveRight);

    // Xử lý nút Xuống riêng để tăng tốc độ rơi
    const btnDown = document.getElementById("btn_down");
    btnDown.onmousedown = btnDown.ontouchstart = e => {
        e.preventDefault(); if (isGameOver || controls.down.i) return;
        clearInterval(fallInterval);
        const fastDrop = () => {
            if(canMove(posX, posY+1, shape)) { posY++; drawShape(); }
            else { lockBlock(); spawnBlock(); drawShape(); }
        };
        fastDrop();
        controls.down.i = setInterval(fastDrop, 50);
    };
    btnDown.onmouseup = btnDown.onmouseleave = btnDown.ontouchend = () => {
        clearInterval(controls.down.i); controls.down.i = null;
        startFall();
    };

    // Nút xoay tách biệt hoàn toàn
    const btnRotate = document.getElementById("btn_rotate");
    btnRotate.onmousedown = btnRotate.ontouchstart = e => {
        e.preventDefault(); rotate();
    };
}

let fallInterval;
function startFall(){
    clearInterval(fallInterval);
    fallInterval = setInterval(() => {
        if(!isGameOver){
            if(canMove(posX,posY+1,shape)) { posY++; drawShape(); }
            else { lockBlock(); spawnBlock(); drawShape(); }
        }
    }, fallSpeed);
}

setupControls();
spawnBlock();
startFall();
drawShape();
</script>
</html>